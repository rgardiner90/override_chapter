---
title: "Model"
author: "Richard G. Gardiner"
date: "2/20/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data and Packages

When you start looking at the model, look at [David's Tidy Tuesday project](https://mobile.twitter.com/drob/status/1082318029168566273?s=21). Also check out [this post](https://hockey-graphs.com/2019/01/07/quantifying-differences-between-the-regular-season-and-playoffs-using-survival-analysis/?blogsub=confirming#subscribe-blog).  Lastly, I like [this link](https://rpubs.com/daspringate/survival)

```{r, packages}
library(tidyverse)
library(survival)
library(survminer)
library(broom)
library(scales)
library(devtools)
library(ggfortify)
library(survivalAnalysis)
library(Amelia)
```

```{r}
dataset <- read_csv("data/all_years_all_variables.csv")
head(dataset)

dataset <- dataset %>%
  mutate(Year = Year + 0.01,
         Override = ifelse(Override == 109, 0, Override))



dataset %>%
  group_by(masterid) %>%
  count(masterid)
```

## Amelia 

This uses the data from Amelia to fill in missing data.  
```{r Amelia}
# filled_data <- amelia(dataset, idvars = c("state_abb", "State"))
# 
# write.amelia(filled_data, file.stem = "Amelia_data", format = "csv")
# 
# dataset <- read_csv("data/Amelia_data1.csv")
# 
# dataset
```


Here I am adding the absolute distance variables:

```{r}
# dataset$court_gov_dist <- abs(dataset$judicial - dataset$governor)
# dataset$court_lower_dist <- abs(dataset$judicial - dataset$lower)
# dataset$court_upper_dist <- abs(dataset$judicial - dataset$upper)
```

### Testing Amelia package

```{r}
# test <- dataset
```


## Initial Analysis

```{r}
election <- coxph(formula = Surv(case_year, Year, Override) ~ appointed,
                 data = dataset)
summary(election)
```


```{r}
fit <- survfit(formula = Surv(case_year, Year, Override) ~ appointed,
                 data = dataset)
# ggsurvplot(fit, data = dataset, risk.table = TRUE)
tidy(fit) %>%
  ggplot(aes(time, estimate, color = strata)) +
  geom_line() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .2) +
  scale_color_discrete(name = "Selection System",
                       breaks = c("appointed=1", "appointed=0"),
                       labels = c("Appointed", "Elected")) +
  theme_light() +
  labs(y = "Estimated Likelihood of Survival",
       x = "Year")

# ggsave("figures/Selection Survival.jpeg")
```



## Larger models

### Introducing ideology
```{r}
ideology <- coxph(formula = Surv(case_year, Year, Override) ~ appointed +
                ideologically_similar,
                data = dataset)

summary(ideology)
cox.zph(ideology) # testing for proportional hazards
```



```{r}
ideology_fit <- survfit(formula = Surv(case_year, Year, Override) ~ appointed +
                ideologically_similar,
                data = dataset)


plot(survfit(ideology),
     xlim = c(1995,2012),
     ylim = c(.99, 1.0))

tidy(ideology_fit) %>%
  mutate(strata = if_else(strata == "appointed=0, ideologically_similar=1", "Elected and Similar",
                          if_else(strata == "appointed=0, ideologically_similar=0", "Elected and Dissimilar",
                                  if_else(strata == "appointed=1, ideologically_similar=0", 
                                          "Appointed and Dissimilar", "Appointed and Similar")))) %>%
  ggplot(aes(time, estimate, color = strata)) +
  geom_line() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .2) +
  facet_wrap(~strata) +
  theme_light() +
  labs(y = "Estimated Likelihood of Survival",
       x = "Year",
       color = "Selection System and \nIdeological Similarity")

# ggsave("figures/Selection and Ideology survival.jpeg")
```


### adding in interaction terms


```{r}
dataset <- dataset %>%
  mutate(appointed_similar = appointed * ideologically_similar)


interactions <- coxph(formula = Surv(case_year, Year, Override) ~ appointed + ideologically_similar +
                appointed_similar,
                data = dataset)
summary(interactions)

interactions_fit <- survfit(formula = Surv(case_year, Year, Override) ~ appointed + ideologically_similar +
                appointed_similar,
                data = dataset)

tidy(interactions_fit) %>%
  mutate(strata = if_else(strata == "appointed=0, ideologically_similar=0, appointed_similar=0", 
                          "Elected and Dissimilar",
                          if_else(strata == "appointed=0, ideologically_similar=1, appointed_similar=0",
                                  "Elected and Similar",
                                  if_else(strata == 
                                            "appointed=1, ideologically_similar=1, appointed_similar=1", 
                                          "Appointed and Similar", "Appointed and Dissimilar")))) %>%
  filter(strata %in% c("Elected and Dissimilar", "Elected and Similar", "Appointed and Similar",
                       "Appointed and Dissimilar")) %>%
  ggplot(aes(time, estimate, color = strata)) +
  geom_line() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .2) +
  facet_wrap(~strata) +
  theme_light() +
  labs(y = "Estimated Likelihood of Survival",
       x = "Year",
       color = "Interaction between Selection System \nand Ideological Similarity")  

# ggsave("figures/Interaction Survival.jpeg")
```

### Controls
```{r}

control_dataset <- dataset %>%
  filter(agency != 88)

controls <- coxph(formula = Surv(case_year, Year, Override) ~ appointed +
                ideologically_similar + appointed_similar + classact + Moralistic + Traditionalistic +
                Professionalization + unified,
                data = control_dataset)

summary(controls)
```



```{r}
controls_fit <- survfit(formula = Surv(case_year, Year, Override) ~ appointed +
                ideologically_similar + appointed_similar + classact + Moralistic + Traditionalistic +
                Professionalization + unified,
                data = control_dataset)

tidy(controls_fit) %>%
  mutate(strata = if_else(strata == "appointed=0, ideologically_similar=0, appointed_similar=0, classact=FALSE, Moralistic=0, Traditionalistic=0, Professionalization=1, unified=1", "elected, similar, not professional",
                           if_else(strata == "appointed=0, ideologically_similar=0, appointed_similar=0, classact=FALSE, Moralistic=0, Traditionalistic=0, Professionalization=5, unified=1", "elected, similar, most professional", strata))) %>%
  filter(strata %in% c("elected, similar, not professional", "elected, similar, most professional",
                       "appointed, similar, not professional", "appointed, similar, most professional")) %>%
  ggplot(aes(time, estimate, color = strata)) +
  geom_line() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high), alpha = .2) +
  facet_wrap(~strata) +
  theme_light() +
  labs(y = "Estimated Likelihood of Survival",
       x = "Year",
       color = "Selection System and Professionalization")  
```


## Looking at clustering and frailty models (MLM)

Below are the four models.  Nothing terrible different.  In the final model, nothing is significant.  
```{r}
election_cluster <- coxph(formula = Surv(case_year, Year, Override) ~ appointed + cluster(state_2),
                 data = dataset)
summary(election_cluster)
```

```{r}
ideology_cluster <- coxph(formula = Surv(case_year, Year, Override) ~ appointed +
                ideologically_similar + cluster(state_2),
                data = dataset)

summary(ideology_cluster)
```

```{r}
interactions_cluster <- coxph(formula = Surv(case_year, Year, Override) ~ 
                                appointed + ideologically_similar + appointed_similar +
                                + cluster(state_2),
                data = dataset)
summary(interactions_cluster)
```

```{r}
controls_cluster <- coxph(formula = Surv(case_year, Year, Override) ~ appointed +
                ideologically_similar + appointed_similar + classact + Moralistic + Traditionalistic +
                Professionalization + unified + cluster(state_2),
                data = control_dataset)

summary(controls_cluster) 
```

